name: 'Mediawiki Extension PHPUnit Runner'
description: 'Setups MediaWiki and runs PHPUnit test for an extension'
author: 'WikiTeq'
branding:
  color: yellow
  icon: book-open
inputs:
  php:
    description: 'PHP version'
    required: true
  mwbranch:
    description: 'Mediawiki branch to test against'
    required: true
  extension:
    description: 'Extension name to test'
    required: true
  testgroup:
    description: 'Extension tests @group'
    required: true
  type:
    description: 'Is it an extension or skin'
    required: false
    default: 'extension'
runs:
  using: 'composite'
  steps:
    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ inputs.php }}
        extensions: mbstring, intl
        tools: composer:2.1.14

    - name: Add Composer cache
      uses: actions/cache@v2
      with:
        path: ~/.composer/cache
        key: composer-php${{ inputs.php }}

    - name: Install MediaWiki
      run: bash $GITHUB_ACTION_PATH/install.sh ${{ inputs.mwbranch }} ${{ inputs.extension }} ${{ inputs.type }}
      shell: bash

# Commenting this for experimentational purposes as the extension to be tested is placed in the local folder. However this following code makes use of a remote git repository of a wikimedia extension to test it
#     - uses: actions/checkout@v2
#       with:
#         path: mediawiki/${{ inputs.type }}s/${{ inputs.extension }}

    - name: Composer updates
      working-directory: mediawiki
      run: composer update
      shell: bash

    - name: Run PHPUnit
      working-directory: mediawiki
      run: php tests/phpunit/phpunit.php --group ${{ inputs.testgroup }}
      shell: bash
