name: 'Mediawiki Extension PHPUnit Runner'
description: 'Setups MediaWiki and runs PHPUnit test for an extension'
author: 'Jonty16117'
branding:
  color: yellow
  icon: book-open
inputs:
  php:
    description: 'PHP version'
    required: true
  mwbranch:
    description: 'Mediawiki branch to test against'
    required: true
  # extension:
  #   description: 'Extension name to test'
  #   required: true
  # testgroup:
  #   description: 'Extension tests @group'
  #   required: true
  # type:
  #   description: 'This is a unit test'
  #   required: false
  #   default: 'extension'
runs:
  using: 'composite'
  steps:
    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ inputs.php }}
        extensions: mbstring, intl
        tools: composer:2.1.14

    - name: Add Composer cache
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: composer-php${{ inputs.php }}

    - name: Install MediaWiki
      run: bash $GITHUB_ACTION_PATH/install.sh ${{ inputs.mwbranch }}
      shell: bash

    - uses: actions/checkout@v3
      with:
        path: mediawiki/mwstake

    - name: Composer updates
      working-directory: mediawiki
      run: composer update
      shell: bash

    - name: Run PHPUnit
      working-directory: mediawiki/mwstake/${{ inputs.mwstakecomponent }}
      run: php tests/phpunit/phpunit.php
      shell: bash
